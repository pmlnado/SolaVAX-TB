---
title: "SvX Day30 Lesion Area"
author: "Pablo Maldonado"
date: "11/2/2023"
output: html_document
---


```{r global options, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, error = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(dplyr)
library(purrr)
library(tidyr)
library(stringr)
library(tidyverse)
library(gridExtra)
library(ggplot2)
library(ggpubr)
library(scales)
library(gridExtra)
library(emmeans)
library(viridis)
library(vcd)
library(ggmosaic)
```

```{r}

# Define the file path
file_path <- "/Volumes/rstor-henao_lab/SolaVAX-TB/SVX Histology/SolaVAX-TB_Lesion-area-cell-counts.xlsx"

# Read the Excel file into a data frame
lesion_area <- read_excel(file_path)

lesion_area

split <- str_split_fixed(lesion_area$Name, "\\.", 4)
colnames(split) <- c("name", "mouse", "section", "data")
split <- as.data.frame(split)
split$day <- str_extract(split$name, "\\d{2}$")
split$name <- str_remove(split$name, "\\d{2}$")

lesion_area_expanded <- cbind(split, lesion_area)
lesion_area_expanded <- lesion_area_expanded %>%
  select(-"Name", -"Perimeter µm", -"Area µm^2")


lesion_area_expanded <- lesion_area_expanded %>%
  pivot_wider(names_from = data, values_from = Detections) %>%
  mutate(percent_area = (density/cells)*100)


percent_area <- lesion_area_expanded %>%
  group_by(name, mouse, day) %>%
  summarise(average_percent_burden = mean(percent_area), .groups = "drop")

percent_area
```
```{r}
# # Recode the condition and group names
percent_area  <- percent_area  %>%
  mutate(name = ifelse(name == "IMCPG", "BCG+SvX-IM-CPG",
                       ifelse(name == "INInulin", "BCG+SvX-IN-Inulin", name)))
percent_area$name <- factor(percent_area$name, levels = c("Saline", "BCG1x", "BCG2x", "BCG+SvX-IM-CPG", "BCG+SvX-IN-Inulin"))


ggplot(data = percent_area, aes(x = name, y = average_percent_burden, fill = name, color = name)) +
  geom_boxplot(width = 0.5, alpha = 0.7, position = position_dodge(width = 0.75)) +
  geom_point(size = 3, shape = 21, alpha = 0.9, na.rm = TRUE, color = "black",
             position = position_dodge(width = 0.75)) +
  scale_color_viridis_d(name = "Vaccine", alpha = 1) +  
  scale_fill_viridis_d(name = "Vaccine", alpha = 1) +  
  facet_wrap(~ day, scales = "free_y") +
  labs(title = " ", x = " ", y = " ", color = "Vaccine") +
  theme_bw() + 
  theme(
    strip.text = element_text(color = "black", size = 1.3 * rel(1)),
    axis.text.x = element_blank(),
    axis.title.x = element_text(color = "black", size = 1.3 * rel(1)),
    axis.text.y = element_text(color = "black", size = 1.3 * rel(1)),
    axis.title.y = element_text(color = "black", size = 1.4 * rel(1)),
    legend.position = "bottom",
    legend.title = element_text(color = "black", size = 1.3 * rel(1)),
    legend.text = element_text(color = "black", size = .9 * rel(1)),
    plot.title = element_text(color = "black", size = 15)) +
    scale_y_continuous(limits = function(x) c(min(x), max(x) + 15))

```

